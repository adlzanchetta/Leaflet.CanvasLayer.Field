<!DOCTYPE html>
<html>
  <!--
    Handling multiple layers should be performed with 'panes' and CSS.
    See: 'https://github.com/Leaflet/Leaflet/issues/4', post from 'ghybs'.
  -->

  <head>
    <meta charset="utf-8"/>
    <title>ScalarField / Geotiff (Multiple bands)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="//unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <link rel="stylesheet" href="examples.css" />

    <link href="https://fonts.googleapis.com/css?family=Roboto:100,400" rel="stylesheet">
  </head>

  <body>
    <h1 class="title mapTitle">LayersPlayer</h1>
    <div id="map"></div>

    <!-- CDN -->
    <script src="//d3js.org/d3.v4.min.js"></script>
    <script src="//npmcdn.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="//npmcdn.com/geotiff@0.3.6/dist/geotiff.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>

    <!-- Plugin -->
    <script src="dist/leaflet.canvaslayer.field.js"></script>

    <script>
        // let geotiffUrl = 'data/HRRRfromPando_20180308_h06_prate.tiff';
        let geotiffUrl = 'data/HRRRfromPando_20180308_h06_prate_float32.tiff';
        let map = L.map('map');
        let paneId = 'animated_pane';

        /* Dark basemap */
        let url = 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}.png';
        L.tileLayer(url, {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            pane: paneId
        }).addTo(map);
        
        /* Pane holder for the set of rasters */
        let paneObj = map.createPane(paneId);
        // paneObj.style.border = '1px solid #FF7777';  /** TODO: not working */
        paneObj.style.pointerEvents = 'none';

        /* GeoTIFF with n bands */
        d3.request(geotiffUrl).responseType('arraybuffer').get(
            function (error, tiffData) {
                let scalarFields = L.ScalarField.multipleFromGeoTIFF(tiffData.response);
                let bounds = {};
                let playerReferences = [];
                
                // just add leading zeros
                let padZeros = function (n, width) {
                    n = n + '';
                    return n.length >= width ? n : new Array(width - n.length + 1).join('0') + n;
                }

                // scalarFields = scalarFields.slice(0, 6);  // TODO - temp shortage
                scalarFields.forEach(function (sf, index) {
                    let layerSf = L.canvasLayer.scalarField(sf, {
                        // 'RdPu'
                        color: chroma.scale('BuPu').domain(sf.range),
                        opacity: 0.65,
                        pane: paneId
                    }).addTo(map);
                    
                    playerReferences.push([layerSf, "At: " + padZeros(index, 2) + ":00"]);

                    bounds = layerSf.getBounds();
                });
                
                // player control
                let layersControl = L.control.layersPlayer(playerReferences, paneId, {
                    position: 'bottomleft',
                    collapsed: false,
                    refreshTime: 500,
                    buttons: {
                        stop: {
                            style: {
                                'float': 'left',
                                'display': 'block',
                                'width': '16px',
                                'backgroundColor': '#FF5555',
                                'border': '3px solid #DFDFDF',
                                'margin': '1px',
                                'cursor': 'pointer',
                                'color': '#111111',
                                'textAlign': 'center'
                            }
                        }
                    }
                }).addTo(map);
                
                // response function for onClick
                layersControl.onClick = function (e) {
                    
                    let valueHtmlContent = function (v) {
                        let formatedValue = (v ? v.toFixed(4) : (0).toFixed(4));
                        return '<span class="popupText">Value: ' + formatedValue + ' mm</span>';
                    }
                    
                    if (e.frameChange) {
                        let popUp = L.Control.LayersPlayer.lastCreated.activePopup;
                        if (!popUp) { return; }
                        popUp.setContent(valueHtmlContent(e.value));
                        
                    } else {
                        if (e.value == null){ return; }
                        
                        L.Control.LayersPlayer.lastCreated.activePopup = L.popup()
                            .setLatLng(e.latlng)
                            .setContent(valueHtmlContent(e.value))
                            .openOn(map);
                    }
                    
                };
                
                // move to first layer
                map.fitBounds(bounds);
                layersControl.goTo(0);
            });
    </script>
  </body>

</html>
